<div class="row-fluid">
	<div class="box span12">
		<div class="box-header">
			<h2>Автоответчик</h2>
		</div>
		<div class="box-content">
			<form class="form-horizontal" style="margin: 0;">
			  <fieldset>			

				<div class="control-group" id='editor'>
          <label class="msgs-label">Сообщение для ответа</label>
          <div class="controls">

           <div class="message_container">
            <div class="header_line" id='toolbar'>
              <button class="btn btn-mini trans msg_bold" data-original-title="Жирный" data-rel="tooltip">
                <i class="halflings-icon bold"></i>
              </button>
              <button class="btn btn-mini trans msg_italic"  data-original-title="Курсив" data-rel="tooltip">
                <i class="halflings-icon italic"></i>
              </button>
              <button class="btn btn-mini trans msg_mono"  data-original-title="Моноширинный" data-rel="tooltip">
                <i class="halflings-icon text-width"></i>
              </button>
              
              <button class="btn btn-mini trans msg_url_add"  data-original-title="Добавить ссылку" data-rel="tooltip">
                <i class="halflings-icon font"></i>
              </button>

              <span class="separator"></span>
              
              <button class="btn btn-mini trans msg_forward"  data-original-title="Репост из канала" data-rel="tooltip">
                <i class="halflings-icon share-alt"></i>
              </button>
              <button class="btn btn-mini trans msg_insert_image" data-original-title="Прикрепить фото" data-rel="tooltip">
                <i class="halflings-icon camera"></i>
              </button>
              
              <button class="btn btn-mini trans msg_inline_query"  data-original-title="Inline Query (@postbot, т.д.)" data-rel="tooltip">
                <i class="halflings-icon tasks"></i>
              </button>
              
              <span class="separator"></span>
            
              <button class="btn btn-mini trans msg_spin"  data-original-title="Спинтакс (рандомизация)" data-rel="tooltip">
                <i class="halflings-icon random"></i>
              </button>
              
              <span class="separator"></span>

              <button class="btn btn-mini trans msg_restore"  data-original-title="Восстановить последнее сообщение" data-rel="tooltip">
                <i class="halflings-icon repeat"></i>
              </button>
              
              <button class="btn btn-mini trans msg_clear"  data-original-title="Удалить сообщение" data-rel="tooltip">
                <i class="halflings-icon trash"></i>
              </button>
              

            </div>

            <span id='message_type' type='text', value=''></span>
            <span id='message_settings'></span>

            <textarea id="message" rows="10" placeholder="Введите сообщение здесь"></textarea>

            <div class="overflow_cont">
                <div class="center_content">
                  <h2 id='ov_head'></h2>
                  <button class='cancel_overflow_cont'>Отменить</button>
                </div>
            </div>
          </div>

          <div class="message_preview">
            <div class="img_wrap">
              <img src="/img/noimg.jpg" alt="" class='preview_img'>
              <div class="cencel_img"><div class="text">Отменить</div></div>
            </div>
            <div class="preview_text preview_text_without_img">
              <div class="inner_msg"></div>
              <div class="next">Предпросмотр сообщения</div>
              <span class="message_preview_time">16:00</span>
            </div>
          </div>

          </div>
        </div> 
		</div> 

      <div class="control-group">
        <label class="msgs-label"></label>
          <div class="controls">
            <button id="start" class="btn btn-primary">Запустить</button>
          </div>
      </div>
      
			  </fieldset>
			</form>


		</div>
	</div>
</div>

<div class="row-fluid logs h100vh">
  <div class="box span12">
    <div class="box-header" data-original-title="">
      <h2>Лог работы</h2>
    </div>
    <div class="box-content">
      <div class="log-content h100vh h100p">  
          <ul id="log">


          </ul>
      </div>
    </div>
  </div>
</div> 



<style>
#log {
  max-height: none !important;
  min-height: 0 !important; 
}
</style>




<div class="account_chooser">
  <div class="accounts_chooser_content">
      <div class="box">
      <div class="box-header">
        <h2>Выберите аккаунты для работы (всего доступно <span class="how">0</span> аккаунтов)</h2>
        <div class="box-icon">
          <a href="#" class="btn-close-modal">
            <i class="halflings-icon white remove"></i>
          </a>
        </div>
      </div>
      <div class="box-content">
        <div class="account_range">
          <div class="slider sliderRangeAccountsCheck red"></div> <span class="chose_all">выбрать все</span>
          <div class="field_notice">(<span class="must sliderRangeLabel" style="color:  black;"></span>)</div>
        </div>

        <div class="inner">
          <table class="table table-striped table-bordered">
            <thead class='accounts_list_head_fast'>
              <tr>
                <th></th>
                <th>Аватар</th>
                <th>Юзернейм</th>
                <th>Имя</th>
                <th>Телефон</th>
                <th>Отлёжка</th>
              </tr>
            </thead>   
            <tbody id='accounts_list_fast'></tbody>
          </table> 
        </div>
        <span class="label label-success lnp btn-fast-success">Принять</span>
      </div>
    </div>
  </div>
</div>

<div class="modal-wrapper" id='modal_choose_url'>
  <div class="modal">
    <div class="modal_content">
      <a class="btn-close trigger" href="javascript:;"></a>
      <div class="row-fluid">
        <div class="span12">
          <h1>Введите текст и ссылку</h1>
        </div>
      </div>
      <div class="row-fluid">
        <div class="span6 offset3 center">
          <input type="text" placeholder="Google" id='input_urlname'>
          <input type="text" placeholder="https://google.com" id='input_url'>
          <button>Вставить</button>
        </div>
      </div>
      </div>
  </div>
</div>

<div class="modal-wrapper" id='modal_inline_query'>
  <div class="modal">
    <div class="modal_content">
      <a class="btn-close trigger" href="javascript:;"></a>
      <div class="row-fluid">
        <div class="span12">
          <h1>Введите данные</h1>
        </div>
      </div>
      <div class="row-fluid">
        <div class="span6 offset3 center">
          <input type="text" placeholder="@postbot" id='input_botname_query'>
          <input type="text" placeholder="15c92394a15349" id='input_query'>
          <button>Принять</button>
        </div>
      </div>
      </div>
  </div>
</div>

<div class="modal-wrapper" id='modal_forward'>
  <div class="modal">
    <div class="modal_content">
      <a class="btn-close trigger" href="javascript:;"></a>
      <div class="row-fluid">
        <div class="span12">
          <h1>Введите ссылку на пост в канале</h1>
        </div>
      </div>
      <div class="row-fluid">
        <div class="span6 offset3 center">
          <input type="text" placeholder="https://t.me/test_channel_for_forward/3" id='input_forward_url'>
          <button>Принять</button>
        </div>
      </div>
      </div>
  </div>
</div>

<div class="modal-wrapper" id='modal_insert_image'>
  <div class="modal">
    <div class="modal_content">
      <a class="btn-close trigger" href="javascript:;"></a>
      <div class="row-fluid">
        <div class="span12">
          <h1>Введите ссылку на изображение</h1>
        </div>
      </div>
      <div class="row-fluid">
        <div class="span6 offset3 center">
          <input type="text" placeholder="https://i.imgur.com/E0dconc.jpg" id='input_image_url'>
          <button>Принять</button>
        </div>
      </div>
      </div>
  </div>
</div>

<script src='/js/account_chooser.js'></script>
<script src='/js/message_editor.js'></script>

<script>
$("input:checkbox, input:radio").uniform();
$('[rel="tooltip"],[data-rel="tooltip"]').tooltip({"placement":"bottom",delay: { show: 400, hide: 200 }});


var accounts_info = {}
loading_start()

function msg_sended(data) {
  let accname = `${data.name}: `
  log(accname + `Сообщение автоответчика отправлено: ${data.username}`)
}


$('#start').click(function(e) {
    e.preventDefault()
    $('#log').html('')
    let options = get_options()
    if (options.is_inline_query == false && options.is_repost == false && options.with_file == false && options.text.length < 2) {
      $.gritter.add({
        title: 'Запуск невозможен',
        text: 'Вы пытаетесь отправить пустое сообщение',
      });
      return
    }
    open_account_chooser().then(function(res) {
      if (res.length < 1) {
        $.gritter.add({
          title: 'Запуск невозможен',
          text: 'Выберите аккаунты для работы',
        });
        return
      }
      let options = get_options()
      options['phones'] = res
      console.log(options)
      ws_send({type: 'auto_reply', data: options});
      
      $('#start').addClass('disabledb')
      $('#settings').addClass('disabledb')
      $('#editor').addClass('disabledb')
      $('.insert_from').addClass('disabledb')
    })

    text_disable()
  })



function ws_error(data) {
  var phone = data.phone
  if (data.reason == 'error_connect_to_account') {
    let accname = `${data.name}: `
    log(accname + '<span class="warn">Ошибка подключения к аккаунту. Возможно аккаунт забанен</span>')
  }

  if (data.reason == 'need_wait') {
    log(`${data.name}: <span class="warn_need_wait">Необходимо подождать ${data.seconds} секунд</span>`)
  }
  if (data.reason == 'user_restricted') {
    let accname = `${data.name}: `
    log(accname + '<span class="warn">Пользователь ограничен, но не забанен</span>')
  }

  if (data.reason == 'user_deactivated') {
    let accname = `${data.name}: `
    log(accname + '<span class="warn">Пользователь забанен</span>')
  }

  if (data.reason == 'operational_error') {
    let accname = `${data.name}: `
    log(accname + '<span class="warn">Сессия занята другим процессом</span>')
  }

  if (data.reason == 'auth_key_unregistred') {
    let accname = `${data.name}: `
    log(accname + '<span class="warn">Неверная сессия</span>')
  }

  if (data.reason == 'username_not_found') {
    let accname = `${data.name}: `
    log(accname + '<span class="warn">Контакт не найден: ' + data.username + '</span>')

  }

  if (data.reason == 'error') {
    let accname = `${data.name}: `
    log(accname + '<span class="warn">Произошла ошибка: ' + data.message + '</span>')
  }
}


$(document).ready(function() {
  WS = new ReconnectingWebSocket("ws://localhost:" + location.port + "/websocket");

	WS.onopen = function() {
      loading_stop()
	    ws_send({type: 'get_accounts'});
	    ws_send({type: 'full_account_info'});
	};

  WS.onclose = function(event) {
    loading_start()
    red_log('Соединение с сервером потеряно');
  };
  
	WS.onmessage = function (evt) {
	  var data = JSON.parse(evt.data)
	  var f_data = data.data

    ws_defs(evt);

    if (data.type == 'full_account_info') set_data_for_fast_choose(f_data)
    if (data.type == 'error') ws_error(f_data)
    if (data.type == 'msg_sended') msg_sended(f_data)

	};
})

window.onbeforeunload = function() {
  WS.onclose = function () {};
  WS.close();
};

</script>