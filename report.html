
<div class="row-fluid">
	<div class="box span12">
		<div class="box-header">
			<h2>Массовые репорты</h2>
		</div>
		<div class="box-content">
			<form class="form-horizontal" style="margin: 0;">
				<div class="control-group">
          <div class="head_settings">Массовые репорты</div>
        </div>

<style>
  .report_target_group {
    border: 1px solid #e4e4e4;
    padding: 15px 0px 0px 20px;
    display: inline-block;
    width: 745px;
    border-radius: 2px;
    margin-right: 1000px;
  }
  .add_new_target_group {
    margin-left: 310px;
    margin-bottom: 30px;
    margin-top: 9px;
    cursor: pointer;
    width: 100px;
    border-top: none;
    text-align: center;
    padding-top: 5px;
    padding-bottom: 0px;
    color: green;
  }
  .report_target_group:not(:last-child) {
    margin-bottom: 15px;
  }
</style>


        <div class="report_targets">

          <div class="report_target_group" target_id="1">
            <div class="control-group">
              <label class='settings-label'><span>Тип</span></label>
              <div class="controls">
                <select id='report_type'>
                  <option value='group'>Группа</option>
                  <option value='channel'>Канал</option>
                  <option value='bot'>Бот</option>
                </select>
              </div>
            </div>
            <div class="control-group channel_iter channel_1">
              <label class='settings-label'><span>Ссылка на цель</span></label>
              <div class="controls">
                 <input class='target' type="text" placeholder="@username" />
              </div>
            </div>
            <div class="control-group">
              <label class='settings-label'><span>Ссылка на сообщение</span></label>

              <div class="controls">
                  <select id='target_message_type'>
                    <option value='last'>Последнее</option>
                    <option value='spec'>Определенное</option>
                  </select>

                  <input class='target_message dis' type="text" placeholder="https://t.me/c/10821354/408534" />
              </div>
            </div>
          </div>
        </div>

        <div class="add_new_target_group">
            <span class="material-icons">add_circle_outline</span>
        </div>

        <div class="control-group">
          <label class='settings-label'><span>Причина репорта</span></label>
          <div class="controls">
            <select id='report_reason'>
              <option value='Spam'>Спам</option>
              <option value='Copyright'>Ненастоящий аккаунт</option>
              <option value='Violence'>Насилие</option>
              <option value='ChildAbuse'>Детская порнография</option>
              <option value='Pornography'>Порнография</option>
              <option value='Other'>Другое</option>
            </select>
          </div>
        </div>

        <div class="control-group">
          <label class='settings-label'><span>Менять причины случайно</span></label>
          <div class="controls">
            <div class="inline_list lh30 pr20">
              <label class="radio vam report_reasons">
                <input type="radio" class="change_report_reason" value="1" name="change_report_reason">
                <span>Да</span>
              </label>
            </div>
            <div class="inline_list lh30 pr20">
              <label class="radio vam report_reasons">
                <input type="radio" class="change_report_reason" value="0" name="change_report_reason">
                <span>Нет</span>
              </label>
            </div>
          </div>
        </div>
        

        <div class="control-group">
          <label class='settings-label'><span>Текст причины</span></label>
          <div class="controls">
             <textarea id="reason_text" rows="10" placeholder="Текст причины (каждый вариант с новой строки, используются по очереди)"></textarea>
          </div>
        </div>
        
        
        <style>
          #delay_between_report_from, #delay_between_report_to {
            width: 50px;
            margin: 0 3px;
          }
          
        </style>


        <div class="control-group">
          <label class='settings-label'><span>Задержка между каждым репортом</span></label>
          <div class="controls">
             от <input id='delay_between_report_from' value="5" type="number" min="1" step="1"/> до <input id='delay_between_report_to' value="20" type="number" min="1" step="1"/> <span class="pl5"> секунд (случайная)</span>
          </div>
        </div>

        <div class="control-group">
          <label class='settings-label'><span>Подписываться на канал/группу</span></label>
          <div class="controls">
            <div class="inline_list lh30 pr20 dont_subscribe">
              <label class="radio vam dont_subscribe">
                <input type="radio" class="dont_subscribe" value="1" name="dont_subscribe">
                <span>Да</span>
              </label>
            </div>
            <div class="inline_list lh30 pr20 dont_subscribe">
              <label class="radio vam dont_subscribe">
                <input type="radio" class="dont_subscribe" value="0" name="dont_subscribe">
                <span>Нет</span>
              </label>
            </div>
          </div>
        </div>

        <div class="control-group">
          <label class='settings-label'><span>Выходить из каналов/групп</span></label>
          <div class="controls">
            <div class="inline_list lh30 pr20">
              <label class="radio vam leave_groups">
                <input type="radio" class="leave" value="1" name="leave">
                <span>Да</span>
              </label>
            </div>
            <div class="inline_list lh30 pr20">
              <label class="radio vam leave_groups">
                <input type="radio" class="leave" value="0" name="leave">
                <span>Нет</span>
              </label>
            </div>
          </div>
        </div>

        <div class="control-group">
          <label class='settings-label'><span>Параллельная работа</span></label>
          <div class="controls">
            <div class="inline_list lh30 pr20">
              <label class="radio vam parallel">
                <input type="radio" class="parallel" value="1" name="parallel">
                <span>Да</span>
              </label>
            </div>
            <div class="inline_list lh30 pr20">
              <label class="radio vam parallel">
                <input type="radio" class="parallel" value="0" name="parallel">
                <span>Нет</span>
              </label>
            </div>
          </div>
        </div>
        

        <div class="control-group">
          <label class="settings-label"><span>Количество ботов за проход</span></label>
          <div class="controls">
             <input id="concurents" style="width:100px;" class='dis' value="5" type="number" min="1" step="1">
          </div>
        </div>



        <div class="control-group">
            <button id="start_reports" class="btn btn-large btn-success">Начать</button>
        </div>

			</form>


		</div>
	</div>
</div>

<div class="row-fluid logs h100vh">
  <div class="box span12">
    <div class="box-header" data-original-title="">
      <h2>Лог работы</h2>
    </div>
    <div class="box-content">
      <div class="log-content h100vh h100p">  
          <ul id="log">
          </ul>
      </div>
    </div>
  </div>
</div> 



<style>
#log {
  max-height: none !important;
  min-height: 0 !important; 
}
#reason_text {
    height: 200px;
    padding: 7px;
    border: 1px solid #e4e4e4;
    display: inherit;
    min-width: 400px;
    box-sizing: border-box;
    margin-top: 4px;
    width: 450px;
}
#receivers_text {
    width: 220px;
    box-sizing: border-box;
}
</style>

<div class="account_chooser">
  <div class="accounts_chooser_content">
      <div class="box">
      <div class="box-header">
        <h2>Выберите аккаунты для работы (всего доступно <span class="how">0</span> аккаунтов)</h2>
        <div class="box-icon">
          <a href="#" class="btn-close-modal">
            <i class="halflings-icon white remove"></i>
          </a>
        </div>
      </div>
      <div class="box-content">
        <div class="account_range">
          <div class="slider sliderRangeAccountsCheck red"></div> <span class="chose_all">выбрать все</span>
          <div class="field_notice">(<span class="must sliderRangeLabel" style="color:  black;"></span>)</div>
        </div>

        <div class="inner">
          <table class="table table-striped table-bordered">
            <thead class='accounts_list_head_fast'>
              <tr>
                <th></th>
                <th>Аватар</th>
                <th>Юзернейм</th>
                <th>Имя</th>
                <th>Телефон</th>
                <th>Отлёжка</th>
              </tr>
            </thead>   
            <tbody id='accounts_list_fast'></tbody>
          </table> 
        </div>
        <span class="label label-success lnp btn-fast-success">Принять</span>
      </div>
    </div>
  </div>
</div>



<script src='/js/account_chooser.js'></script>


<script>
$('[rel="tooltip"],[data-rel="tooltip"]').tooltip({"placement":"bottom",delay: { show: 400, hide: 200 }});
$('input[type="radio"][value=0]').attr('checked', 'checked')
$('input[class=leave][value=0]').removeAttr('checked')
$('input[class=leave][value=1]').attr('checked', 'checked')
$('input[class=dont_subscribe][value=0]').attr('checked', 'checked')

function add_chan_handler() {
    $('.add_chan').click(function() {
      let already_have = $('.channel_iter').length;
      
      if (already_have != 0) {
        $('#target_message_type').addClass('dis');
        $('.target_message').addClass('dis');
        $('#target_message_type').val('last');
      } else {
        $('#target_message_type').removeClass('dis');
        $('.target_message').removeClass('dis');
      }

      if (already_have >= 3) {
        var targets = [];
        for (let tg of $('.target')) {
          if ($(tg).val().length > 0) {
            targets.push($(tg).val());
          }
        }

        $('.channels_append').remove();
        $('.channel_iter .controls').html('<textarea id="receivers_text" rows="8"></textarea>');
        $('#receivers_text').val(targets.join('\n') + '\n')

        return
      }

      $('.add_chan').remove();
      let html = `<div class="control-group channel_iter channels_append channel_${already_have+1}">
          <label class='settings-label'><span></span></label>
          <div class="controls">
             <input class='target' type="text" placeholder="@username" /> <i class="icon-plus-sign add_chan"></i>
          </div>
        </div>`

      $(html).insertAfter('.channel_' + already_have);
      add_chan_handler();
    })
  }

  add_chan_handler();

function ws_report_end(data) {
  $('#start_reports').removeClass('disabledb')

  log('')
  log(`<span class="account_name">Рассылка репортов заняла ${data.time}</span>`)

  log('')
  log(`<span class="log_success">Рассылка репортов завершена</span>`)
}

$('input[type=radio][name=change_report_reason]').change(function() {
    if (this.value == '1') {
        $('#report_reason').addClass('dis');
    } else {
        $('#report_reason').removeClass('dis');
    }
});

$('.report_targets').on('change', '#report_type', function() {
  let _type = $(this).val();

  let dv = $(this).parent().parent().parent();

  if (_type != 'bot') {
    $(dv).find('.target_message').removeClass('dis');
    $(dv).find('#target_message_type').removeClass('dis');
    return;
  }

  $(dv).find('.target_message').addClass('dis');
  $(dv).find('#target_message_type').addClass('dis');
  $(dv).find('.target_message').val('');
});

$('.report_targets').on('change', '#target_message_type', function() {
  let dv = $(this).parent();
  if ($(dv).find('#target_message_type').val() == 'last') {
    $(dv).find('.target_message').addClass('dis');
  } else {
    $(dv).find('.target_message').removeClass('dis');
  }
});

$('#report_type').on('change', function() {
  if ($('#report_type').val() == 'user') {
    $('#report_reason').addClass('dis');
    $('.report_reasons').addClass('dis');
    $('.leave_groups').addClass('dis');
    $('.dont_subscribe').addClass('dis');
    return
  } 

  if ($('#report_type').val() == 'bot') {
    $('.leave_groups').addClass('dis');
    $('.dont_subscribe').addClass('dis');
    return
  }

  $('#report_reason').removeClass('dis');
  $('.report_reasons').removeClass('dis');
  $('.leave_groups').removeClass('dis');
  $('.parallel').removeClass('dis');
  $('.dont_subscribe').removeClass('dis');
})

$('.parallel').on('change', function() {
  var val = $('input[class=parallel]:checked').val();
  if (val == '0') {
    $('#concurents').addClass('dis');
  } else {
    $('#concurents').removeClass('dis');
  }
})

$('#start_reports').click(function(e) {
  e.preventDefault()

  open_account_chooser().then(function(res) {
    
    let targets_channels = [];
    for (let targ of $('.report_target_group')) {
      let report_type = $(targ).find('#report_type').val();
      let target_message = $(targ).find('.target_message').val();
      let target_message_type = $(targ).find('#target_message_type').val();
      let target = $(targ).find('.target').val();
      targets_channels.push({
        report_type, target_message, target_message_type, target
      });
    }


    var reason = $('#report_reason').val(); // ChildAbuse Violence Copyright Pornography Spam Other
    var change_reason = $('input[class=change_report_reason]:checked').val() || '0';
    var leave = $('input[class=leave]:checked').val() || '0';
    var parallel = $('input[class=parallel]:checked').val() || '0';
    var dont_subscribe = $('input[class=dont_subscribe]:checked').val() || '0';
    var reason_text = $('#reason_text').val();
    var delay_from = $('#delay_between_report_from').val();
    var delay_to = $('#delay_between_report_to').val();
    var concurents = $('#concurents').val();
    
    var data = {
      targets: targets_channels,
      reason,
      change_reason,
      reason_text,
      delay_from,
      delay_to,
      leave,
      parallel,
      concurents,
      dont_subscribe,
    };

    data['phones'] = res;
    $('#log').html('')
    console.log(data);
    $('#start_reports').addClass('disabledb')
     ws_send({type: 'start_reports', data: data});
  })

})

var accounts_info = {}
loading_start()


function ws_error(data) {
  var phone = data.phone
  if (data.reason == 'error_connect_to_account') {
    let accname = `${data.name}: `
    log(accname + '<span class="warn">Ошибка подключения к аккаунту. Возможно аккаунт забанен</span>')
  }

  if (data.reason == 'need_wait') {
    log(`${data.name}: <span class="warn_need_wait">Необходимо подождать ${data.seconds} секунд</span>`)
  }
  if (data.reason == 'user_restricted') {
    let accname = `${data.name}: `
    log(accname + '<span class="warn">Пользователь ограничен, но не забанен</span>')
  }

  if (data.reason == 'user_deactivated') {
    let accname = `${data.name}: `
    log(accname + '<span class="warn">Пользователь забанен</span>')
  }

  if (data.reason == 'operational_error') {
    let accname = `${data.name}: `
    log(accname + '<span class="warn">Сессия занята другим процессом</span>')
  }

  if (data.reason == 'auth_key_unregistred') {
    let accname = `${data.name}: `
    log(accname + '<span class="warn">Неверная сессия</span>')
  }

  if (data.reason == 'username_not_found') {
    let accname = `${data.name}: `
    log(accname + '<span class="warn">Контакт не найден: ' + data.username + '</span>')

  }

  if (data.reason == 'error') {
    let accname = `${data.name}: `
    log(accname + '<span class="warn">Произошла ошибка: ' + data.message + '</span>')
  }
}


$('.add_new_target_group').on('click', function() {
  let last_id = $('.report_target_group:last').attr('target_id');
  let group = $('.report_target_group:last').clone().insertAfter('.report_target_group:last');

  $(group).attr('target_id', +last_id + 1);
  $(group).find('.target_message').addClass('dis');
  $(group).find('.target_message').val('');
  $(group).find('#target_message_type').val('last');
  $(group).find('#report_type').val('group');
  $(group).find('.target').val('');
});


$(document).ready(function() {
  WS = new ReconnectingWebSocket("ws://localhost:" + location.port + "/websocket");
  
	WS.onopen = function() {
      loading_stop()

	    ws_send({type: 'get_accounts'});
	    ws_send({type: 'full_account_info'});
	};

  WS.onclose = function(event) {
      loading_start()
      red_log('Соединение с сервером потеряно');
    };

	WS.onmessage = function (evt) {
	  var data = JSON.parse(evt.data)
	  var f_data = data.data
    ws_defs(evt);
  
    if (data.type == 'full_account_info') set_data_for_fast_choose(f_data)
    if (data.type == 'error') ws_error(f_data)
    if (data.type == 'report_end') ws_report_end(f_data)
	};
})


window.onbeforeunload = function() {
  WS.onclose = function () {};
  WS.close();
};

</script>